function createMapView(e,t,i,a,o,n,r,l,d){function s(e,t,i,a){var o=6371,n=(i-e).toRad(),r=(a-t).toRad(),l=Math.sin(n/2)*Math.sin(n/2)+Math.cos(e.toRad())*Math.cos(i.toRad())*Math.sin(r/2)*Math.sin(r/2),d=2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l)),s=o*d;return s}(null==i||""==i)&&(i="Venue Map");var u=Titanium.UI.createView({backgroundColor:"#FFF",title:i,height:Ti.UI.FILL,width:Ti.UI.FILL}),c=require("/builders/todaysDate"),f=c(),m=[],g=require("/builders/databaseFunctions/createDatabase"),h=g("/venuefinder.db","venuefinder");if(1==a)Number.prototype.toDeg=function(){return 180*this/Math.PI},Number.prototype.toRad=function(){return this*Math.PI/180},Titanium.Geolocation.getCurrentPosition(function(t){if(1!=t.code&&"1"!=t.code){Ti.API.info("e.code: "+t.code);var i=require("/builders/databaseFunctions/createDatabase"),a=i("/venuefinder.db","venuefinder"),c=t.coords.latitude;Ti.API.info("curLat"+c);var g=t.coords.longitude;Ti.API.info("curLon"+g);var h=require("ti.map"),T="SELECT * FROM Venue JOIN VenueCoords ON Venue.VenueID=VenueCoords.VenueID";1==d&&(T='SELECT * FROM Venue JOIN VenueCoords ON Venue.VenueID=VenueCoords.VenueID JOIN Offers ON Venue.VenueID=Offers.EntryID WHERE Offers.EntryType="V" AND Offers.validToDate>="'+f+'" AND Venue.PackageCode!="FRE"');for(var p=0,I=a.execute(T);I.isValidRow()&&500!=p;){var v=I.fieldByName("VenueID"),b=I.fieldByName("Latitude"),w=I.fieldByName("Longitude");if(s(c,g,b,w)<=10){p+=1;var E=I.fieldByName("PackageCode"),S=I.fieldByName("VenueName"),U=I.fieldByName("AddressLine1"),A=I.fieldByName("Town"),L=I.fieldByName("County"),y=I.fieldByName("Postcode");if(""!=U&&null!=U)var U=U+", ";else var U="";if(""!=A&&null!=A)var A=A+", ";else var A="";if(""!=L&&null!=L)var L=L+", ";else var L="";if(""!=y&&null!=y)var y=y;else var y="";var P=h.createAnnotation({latitude:b,longitude:w,title:S,subtitle:U+A+L+y,myid:v});"Android"!=Ti.App.Properties.getString("osname")?(P.setRightButton(Titanium.UI.iPhone.SystemButton.DISCLOSURE),P.setPincolor("FRE"!=E?h.ANNOTATION_RED:h.ANNOTATION_GREEN)):P.setImage("FRE"!=E?"/images/redPin.png":"/images/greenPin.png"),m.push(P)}I.next()}if("Android"==Ti.App.Properties.getString("osname")){var F=h.isGooglePlayServicesAvailable();switch(F){case h.SUCCESS:Ti.API.info("Google Play services is installed.");break;case h.SERVICE_MISSING:alert("Google Play services is missing. Please install Google Play services from the Google Play store.");break;case h.SERVICE_VERSION_UPDATE_REQUIRED:alert("Google Play services is out of date. Please update Google Play services.");break;case h.SERVICE_DISABLED:alert("Google Play services is disabled. Please enable Google Play services.");break;case h.SERVICE_INVALID:alert("Google Play services cannot be authenticated. Reinstall Google Play services.");break;default:alert("Unknown error.")}}var k=h.createView({mapType:h.NORMAL_TYPE,region:{latitude:c,longitude:g,latitudeDelta:.01,longitudeDelta:.01},animate:!0,regionFit:!0,userLocation:!0,zIndex:"1",annotations:m});u.add(k),k.addEventListener("click",function(t){if("rightButton"==t.clicksource||"title"==t.clicksource||"subtitle"==t.clicksource)if(null==n?n=t.annotation.myid:null!=n&&null==r?r=t.annotation.myid:null!=n&&null!=r&&null==l&&(l=t.annotation.myid),0==d||null==d){var i=require("/builders/createApplicationWindow");i(e,"children/featuredListing",t.annotation.title,"#FFF",o,n,r,l,t.annotation.myid,null)}else{var i=require("/builders/createApplicationWindow");i(e,"children/featuredListing",t.annotation.title,"#FFF",o,n,r,l,t.annotation.myid,"Offers")}});var V=Ti.UI.createView({left:-360,bottom:40,width:250,height:233,backgroundColor:"#000",opacity:.8,zIndex:2}),N=Ti.UI.createImageView({image:"/images/mapkey.png",bottom:40,left:0,height:38,zIndex:2});u.add(N),u.add(V);var O=Ti.UI.createImageView({image:"/images/map_key.png",color:"#666",opacity:1,width:250,height:233,zIndex:1});V.add(O);var C=Titanium.UI.createView({width:"45%",height:"10%",top:"60%",left:"5%",zIndex:"3"});C.addEventListener("click",function(){k.setMapType(h.NORMAL_TYPE)}),V.add(C);var R=Titanium.UI.createView({width:"55%",height:"10%",top:"72%",left:"5%",zIndex:"3"});R.addEventListener("click",function(){k.setMapType(h.SATELLITE_TYPE)}),V.add(R);var _=Titanium.UI.createView({width:"50%",height:"10%",top:"85%",left:"5%",zIndex:"3"});_.addEventListener("click",function(){k.setMapType(h.HYBRID_TYPE)}),V.add(_),N.addEventListener("click",function(){1==N._left?(V.animate({left:-250,duration:775}),N.animate({left:0,duration:775}),N._left=!1):(N.animate({left:250,duration:775}),N._left=!0,V.animate({left:0,duration:775}))})}else{var B=Ti.UI.createAlertDialog({title:"Could not connect",message:"We could not determine your current location, please ensure that you are connected to the internet and have location services turned on, in your phone settings"});B.show()}});else{for(var T=0,p=0,I=require("ti.map"),v=h.execute(t);v.isValidRow();){var b=v.fieldByName("VenueID"),w=v.fieldByName("Latitude"),E=v.fieldByName("Longitude"),S=v.fieldByName("PackageCode"),U=v.fieldByName("VenueName"),A=v.fieldByName("AddressLine1"),L=v.fieldByName("Town"),y=v.fieldByName("County"),P=v.fieldByName("Postcode");if(""!=A&&null!=A)var A=A+", ";else var A="";if(""!=L&&null!=L)var L=L+", ";else var L="";if(""!=y&&null!=y)var y=y+", ";else var y="";if(""!=P&&null!=P)var P=P;else var P="";var F=I.createAnnotation({latitude:w,longitude:E,title:U,subtitle:A+L+y+P,myid:b});"Android"!=Ti.App.Properties.getString("osname")?(F.setRightButton(Titanium.UI.iPhone.SystemButton.DISCLOSURE),F.setPincolor("FRE"!=S?I.ANNOTATION_RED:I.ANNOTATION_GREEN)):(F.setRightButton(Titanium.UI.iPhone.SystemButton.DISCLOSURE),F.setImage("FRE"!=S?"/images/redPin.png":"/images/greenPin.png")),m.push(F),T=w.toString(),p=E.toString(),v.next()}if("Android"==Ti.App.Properties.getString("osname")){var k=I.isGooglePlayServicesAvailable();switch(k){case I.SUCCESS:Ti.API.info("Google Play services is installed.");break;case I.SERVICE_MISSING:alert("Google Play services is missing. Please install Google Play services from the Google Play store.");break;case I.SERVICE_VERSION_UPDATE_REQUIRED:alert("Google Play services is out of date. Please update Google Play services.");break;case I.SERVICE_DISABLED:alert("Google Play services is disabled. Please enable Google Play services.");break;case I.SERVICE_INVALID:alert("Google Play services cannot be authenticated. Reinstall Google Play services.");break;default:alert("Unknown error.")}}var V=I.createView({mapType:I.NORMAL_TYPE,animate:!0,regionFit:!0,userLocation:!0,zIndex:1,annotations:m});u.add(V),V.addEventListener("complete",function(){V.setRegion({latitude:T,longitude:p,latitudeDelta:.5,longitudeDelta:.5}),V.removeEventListener("complete",function(){})}),V.addEventListener("click",function(t){if("rightButton"==t.clicksource||"title"==t.clicksource||"subtitle"==t.clicksource){null==n?n=t.annotation.myid:null!=n&&null==r?r=t.annotation.myid:null!=n&&null!=r&&null==l&&(l=t.annotation.myid);{var i=require("/builders/createApplicationWindow");i(e,"children/featuredListing",t.annotation.title,"#FFF",o,n,r,l,t.annotation.myid,null)}}});var N=Ti.UI.createView({left:-360,bottom:40,width:250,height:233,backgroundColor:"#000",opacity:.8,zIndex:2}),O=Ti.UI.createImageView({image:"/images/mapkey.png",bottom:40,left:0,height:38,zIndex:2});u.add(O),u.add(N);var C=Ti.UI.createImageView({image:"/images/map_key.png",color:"#666",opacity:1,width:250,height:233,zIndex:1});N.add(C);var R=Titanium.UI.createView({width:"45%",height:"10%",top:"60%",left:"5%",zIndex:"3"});R.addEventListener("click",function(){V.setMapType(I.NORMAL_TYPE)}),N.add(R);var _=Titanium.UI.createView({width:"55%",height:"10%",top:"72%",left:"5%",zIndex:3});_.addEventListener("click",function(){V.setMapType(I.SATELLITE_TYPE)}),N.add(_);var B=Titanium.UI.createView({width:"50%",height:"10%",top:"85%",left:"5%",zIndex:3});B.addEventListener("click",function(){V.setMapType(I.HYBRID_TYPE)}),N.add(B),O.addEventListener("click",function(){1==O._left?(N.animate({left:-250,duration:775}),O.animate({left:0,duration:775}),O._left=!1):(O.animate({left:250,duration:775}),O._left=!0,N.animate({left:0,duration:775}))})}return h.close(),u}module.exports=createMapView;