function createMapView(e,t,i,a,n,o,r,d,l){function s(e,t,i,a){var n=6371,o=(i-e).toRad(),r=(a-t).toRad(),d=Math.sin(o/2)*Math.sin(o/2)+Math.cos(e.toRad())*Math.cos(i.toRad())*Math.sin(r/2)*Math.sin(r/2),l=2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)),s=n*l;return s}(null==i||""==i)&&(i="Venue Map");var u=Titanium.UI.createView({backgroundColor:"#FFF",title:i,height:Ti.UI.FILL,width:Ti.UI.FILL}),c=require("/builders/todaysDate"),f=c(),m=[],T=require("/builders/databaseFunctions/createDatabase"),h=T("/venuefinder.db","venuefinder"),g=require("ti.map");if("Android"==Ti.App.Properties.getString("osname")){var p=g.isGooglePlayServicesAvailable();switch(p){case g.SUCCESS:Ti.API.info("Google Play services is installed.");break;case g.SERVICE_MISSING:alert("Google Play services is missing. Please install Google Play services from the Google Play store.");break;case g.SERVICE_VERSION_UPDATE_REQUIRED:alert("Google Play services is out of date. Please update Google Play services.");break;case g.SERVICE_DISABLED:alert("Google Play services is disabled. Please enable Google Play services.");break;case g.SERVICE_INVALID:alert("Google Play services cannot be authenticated. Reinstall Google Play services.");break;default:alert("Unknown error.")}}if(1==a)Number.prototype.toDeg=function(){return 180*this/Math.PI},Number.prototype.toRad=function(){return this*Math.PI/180},Titanium.Geolocation.getCurrentPosition(function(t){if(1!=t.code&&"1"!=t.code){var i=require("/builders/databaseFunctions/createDatabase"),a=i("/venuefinder.db","venuefinder"),c=t.coords.latitude,T=t.coords.longitude,h="SELECT * FROM Venue JOIN VenueCoords ON Venue.VenueID=VenueCoords.VenueID";1==l&&(h='SELECT * FROM Venue JOIN VenueCoords ON Venue.VenueID=VenueCoords.VenueID JOIN Offers ON Venue.VenueID=Offers.EntryID WHERE Offers.EntryType="V" AND Offers.validToDate>="'+f+'" AND Venue.PackageCode!="FRE"');for(var p=0,I=a.execute(h);I.isValidRow()&&500!=p;){var v=I.fieldByName("VenueID"),b=I.fieldByName("Latitude"),w=I.fieldByName("Longitude");if(s(c,T,b,w)<=10){p+=1;var E=I.fieldByName("PackageCode"),U=I.fieldByName("VenueName"),S=I.fieldByName("AddressLine1"),L=I.fieldByName("Town"),A=I.fieldByName("County"),y=I.fieldByName("Postcode");if(""!=S&&null!=S)var S=S+", ";else var S="";if(""!=L&&null!=L)var L=L+", ";else var L="";if(""!=A&&null!=A)var A=A+", ";else var A="";if(""!=y&&null!=y)var y=y;else var y="";var F=g.createAnnotation({latitude:b,longitude:w,title:U,subtitle:S+L+A+y,myid:v});"Android"!=Ti.App.Properties.getString("osname")?(F.setRightButton(Titanium.UI.iPhone.SystemButton.DISCLOSURE),F.setPincolor("FRE"!=E?g.ANNOTATION_RED:g.ANNOTATION_GREEN)):F.setImage("FRE"!=E?"/images/redPin.png":"/images/greenPin.png"),m.push(F)}I.next()}var P=g.createView({mapType:g.NORMAL_TYPE,region:{latitude:c,longitude:T,latitudeDelta:.01,longitudeDelta:.01},animate:!0,regionFit:!0,userLocation:!0,zIndex:"1",annotations:m});u.add(P),P.addEventListener("click",function(t){if("rightButton"==t.clicksource||"title"==t.clicksource||"subtitle"==t.clicksource)if(null==o?o=t.annotation.myid:null!=o&&null==r?r=t.annotation.myid:null!=o&&null!=r&&null==d&&(d=t.annotation.myid),0==l||null==l){var i=require("/builders/createApplicationWindow");i(e,"children/featuredListing",t.annotation.title,"#FFF",n,o,r,d,t.annotation.myid,null)}else{var i=require("/builders/createApplicationWindow");i(e,"children/featuredListing",t.annotation.title,"#FFF",n,o,r,d,t.annotation.myid,"Offers")}});var k=Ti.UI.createView({left:-360,bottom:40,width:250,height:233,backgroundColor:"#000",opacity:.8,zIndex:2}),V=Ti.UI.createImageView({image:"/images/mapkey.png",bottom:40,left:0,height:38,width:60,zIndex:2});u.add(V),u.add(k);var N=Ti.UI.createImageView({image:"/images/map_key.png",color:"#666",opacity:1,width:250,height:233,left:0,zIndex:1});k.add(N);var O=Titanium.UI.createView({width:"45%",height:"10%",top:"60%",left:"5%",zIndex:"3"});O.addEventListener("click",function(){P.setMapType(g.NORMAL_TYPE)}),k.add(O);var C=Titanium.UI.createView({width:"55%",height:"10%",top:"72%",left:"5%",zIndex:"3"});C.addEventListener("click",function(){P.setMapType(g.SATELLITE_TYPE)}),k.add(C);var R=Titanium.UI.createView({width:"50%",height:"10%",top:"85%",left:"5%",zIndex:"3"});R.addEventListener("click",function(){P.setMapType(g.HYBRID_TYPE)}),k.add(R),V.addEventListener("click",function(){1==V._left?(k.animate({left:-250,duration:775}),V.animate({left:0,duration:775}),V._left=!1):(V.animate({left:250,duration:775}),V._left=!0,k.animate({left:0,duration:775}))})}else{var _=Ti.UI.createAlertDialog({title:"Could not connect",message:"We could not determine your current location, please ensure that you are connected to the internet and have location services turned on, in your phone settings"});_.show()}});else{for(var I=0,v=0,b=h.execute(t);b.isValidRow();){var w=b.fieldByName("VenueID"),E=b.fieldByName("Latitude"),U=b.fieldByName("Longitude"),S=b.fieldByName("PackageCode"),L=b.fieldByName("VenueName"),A=b.fieldByName("AddressLine1"),y=b.fieldByName("Town"),F=b.fieldByName("County"),P=b.fieldByName("Postcode");if(""!=A&&null!=A)var A=A+", ";else var A="";if(""!=y&&null!=y)var y=y+", ";else var y="";if(""!=F&&null!=F)var F=F+", ";else var F="";if(""!=P&&null!=P)var P=P;else var P="";var k=g.createAnnotation({latitude:E,longitude:U,title:L,subtitle:A+y+F+P,myid:w});"Android"!=Ti.App.Properties.getString("osname")?(k.setRightButton(Titanium.UI.iPhone.SystemButton.DISCLOSURE),k.setPincolor("FRE"!=S?g.ANNOTATION_RED:g.ANNOTATION_GREEN)):(k.setRightButton(Titanium.UI.iPhone.SystemButton.DISCLOSURE),k.setImage("FRE"!=S?"/images/redPin.png":"/images/greenPin.png")),m.push(k),I=E.toString(),v=U.toString(),b.next()}var V=g.createView({mapType:g.NORMAL_TYPE,animate:!0,regionFit:!0,userLocation:!0,zIndex:1,annotations:m});u.add(V),V.addEventListener("complete",function(){V.setRegion({latitude:I,longitude:v,latitudeDelta:.5,longitudeDelta:.5}),V.removeEventListener("complete",function(){})}),V.addEventListener("click",function(t){if("rightButton"==t.clicksource||"title"==t.clicksource||"subtitle"==t.clicksource){null==o?o=t.annotation.myid:null!=o&&null==r?r=t.annotation.myid:null!=o&&null!=r&&null==d&&(d=t.annotation.myid);{var i=require("/builders/createApplicationWindow");i(e,"children/featuredListing",t.annotation.title,"#FFF",n,o,r,d,t.annotation.myid,null)}}});var N=Ti.UI.createView({left:-360,bottom:40,width:250,height:233,backgroundColor:"#000",opacity:.8,zIndex:2}),O=Ti.UI.createImageView({image:"/images/mapkey.png",bottom:40,left:0,height:38,width:60,zIndex:2});u.add(O),u.add(N);var C=Ti.UI.createImageView({image:"/images/map_key.png",color:"#666",opacity:1,width:250,height:233,zIndex:1});N.add(C);var R=Titanium.UI.createView({width:"45%",height:"10%",top:"60%",left:"5%",zIndex:"3"});R.addEventListener("click",function(){V.setMapType(g.NORMAL_TYPE)}),N.add(R);var _=Titanium.UI.createView({width:"55%",height:"10%",top:"72%",left:"5%",zIndex:3});_.addEventListener("click",function(){V.setMapType(g.SATELLITE_TYPE)}),N.add(_);var B=Titanium.UI.createView({width:"50%",height:"10%",top:"85%",left:"5%",zIndex:3});B.addEventListener("click",function(){V.setMapType(g.HYBRID_TYPE)}),N.add(B),O.addEventListener("click",function(){1==O._left?(N.animate({left:-250,duration:775}),O.animate({left:0,duration:775}),O._left=!1):(O.animate({left:250,duration:775}),O._left=!0,N.animate({left:0,duration:775}))})}return h.close(),u}module.exports=createMapView;