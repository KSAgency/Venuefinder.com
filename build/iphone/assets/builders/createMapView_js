function createMapView(e,t,i,a,n,o,r,d,l){function u(e,t,i,a){var n=6371,o=(i-e).toRad(),r=(a-t).toRad(),d=Math.sin(o/2)*Math.sin(o/2)+Math.cos(e.toRad())*Math.cos(i.toRad())*Math.sin(r/2)*Math.sin(r/2),l=2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)),u=n*l;return u}(null==i||""==i)&&(i="Venue Map");var s=Titanium.UI.createView({backgroundColor:"#FFF",title:i,height:Ti.UI.FILL,width:Ti.UI.FILL}),c=require("/builders/todaysDate"),f=c(),m=[],T=require("/builders/databaseFunctions/createDatabase"),h=T("/venuefinder.db","venuefinder");if(1==a)Number.prototype.toDeg=function(){return 180*this/Math.PI},Number.prototype.toRad=function(){return this*Math.PI/180},Titanium.Geolocation.getCurrentPosition(function(t){if(6!=t.code&&"6"!=t.code){var i=require("/builders/databaseFunctions/createDatabase"),a=i("/venuefinder.db","venuefinder"),c=t.coords.latitude,T=t.coords.longitude,h="SELECT * FROM Venue JOIN VenueCoords ON Venue.VenueID=VenueCoords.VenueID";1==l&&(h='SELECT * FROM Venue JOIN VenueCoords ON Venue.VenueID=VenueCoords.VenueID JOIN Offers ON Venue.VenueID=Offers.EntryID WHERE Offers.EntryType="V" AND Offers.validToDate>="'+f+'" AND Venue.PackageCode!="FRE"');for(var g=0,p=a.execute(h);p.isValidRow()&&500!=g;){var I=p.fieldByName("VenueID"),v=p.fieldByName("Latitude"),b=p.fieldByName("Longitude");if(u(c,T,v,b)<=10){g+=1;var w=p.fieldByName("PackageCode"),U=p.fieldByName("VenueName"),S=p.fieldByName("AddressLine1"),E=p.fieldByName("Town"),A=p.fieldByName("County"),L=p.fieldByName("Postcode");if(""!=S&&null!=S)var S=S+", ";else var S="";if(""!=E&&null!=E)var E=E+", ";else var E="";if(""!=A&&null!=A)var A=A+", ";else var A="";if(""!=L&&null!=L)var L=L;else var L="";var y=Titanium.Map.createAnnotation({latitude:v,longitude:b,title:U,subtitle:S+E+A+L,myid:I});"Android"!=Ti.App.Properties.getString("osname")?(y.setRightButton(Titanium.UI.iPhone.SystemButton.DISCLOSURE),y.setPincolor("FRE"!=w?Titanium.Map.ANNOTATION_RED:Titanium.Map.ANNOTATION_GREEN)):y.setImage("FRE"!=w?"/images/redPin.png":"/images/greenPin.png"),m.push(y)}p.next()}var F=Titanium.Map.createView({mapType:Titanium.Map.STANDARD_TYPE,region:{latitude:c,longitude:T,latitudeDelta:.01,longitudeDelta:.01},animate:!0,regionFit:!0,userLocation:!0,zIndex:"1",annotations:m});s.add(F),F.addEventListener("click",function(t){if("rightButton"==t.clicksource||"title"==t.clicksource||"subtitle"==t.clicksource)if(null==o?o=t.annotation.myid:null!=o&&null==r?r=t.annotation.myid:null!=o&&null!=r&&null==d&&(d=t.annotation.myid),0==l||null==l){var i=require("/builders/createApplicationWindow");i(e,"children/featuredListing",t.annotation.title,"#FFF",n,o,r,d,t.annotation.myid,null)}else{var i=require("/builders/createApplicationWindow");i(e,"children/featuredListing",t.annotation.title,"#FFF",n,o,r,d,t.annotation.myid,"Offers")}});var k=Ti.UI.createView({left:-360,bottom:40,width:250,height:233,backgroundColor:"#000",opacity:.8,zIndex:2}),V=Ti.UI.createImageView({image:"/images/mapkey.png",bottom:40,left:0,height:38,zIndex:2});s.add(V),s.add(k);var N=Ti.UI.createImageView({image:"/images/map_key.png",color:"#666",opacity:1,width:250,height:233,zIndex:1});k.add(N);var O=Titanium.UI.createView({width:"45%",height:"10%",top:"60%",left:"5%",zIndex:"3"});O.addEventListener("click",function(){F.setMapType(Titanium.Map.STANDARD_TYPE)}),k.add(O);var C=Titanium.UI.createView({width:"55%",height:"10%",top:"72%",left:"5%",zIndex:"3"});C.addEventListener("click",function(){F.setMapType(Titanium.Map.SATELLITE_TYPE)}),k.add(C);var P=Titanium.UI.createView({width:"50%",height:"10%",top:"85%",left:"5%",zIndex:"3"});P.addEventListener("click",function(){F.setMapType(Titanium.Map.HYBRID_TYPE)}),k.add(P),V.addEventListener("click",function(){1==V._left?(k.animate({left:-250,duration:775}),V.animate({left:0,duration:775}),V._left=!1):(V.animate({left:250,duration:775}),V._left=!0,k.animate({left:0,duration:775}))})}else{var R=Ti.UI.createAlertDialog({title:"Could not connect",message:"We could not determine your current location, please ensure that you are connected to the internet and have location services turned on, in your phone settings"});R.show()}});else{for(var g=0,p=0,I=h.execute(t);I.isValidRow();){var v=I.fieldByName("VenueID"),b=I.fieldByName("Latitude"),w=I.fieldByName("Longitude"),U=I.fieldByName("PackageCode"),S=I.fieldByName("VenueName"),E=I.fieldByName("AddressLine1"),A=I.fieldByName("Town"),L=I.fieldByName("County"),y=I.fieldByName("Postcode");if(""!=E&&null!=E)var E=E+", ";else var E="";if(""!=A&&null!=A)var A=A+", ";else var A="";if(""!=L&&null!=L)var L=L+", ";else var L="";if(""!=y&&null!=y)var y=y;else var y="";var F=Titanium.Map.createAnnotation({latitude:b,longitude:w,title:S,subtitle:E+A+L+y,myid:v});"Android"!=Ti.App.Properties.getString("osname")?(F.setRightButton(Titanium.UI.iPhone.SystemButton.DISCLOSURE),F.setPincolor("FRE"!=U?Titanium.Map.ANNOTATION_RED:Titanium.Map.ANNOTATION_GREEN)):(F.setRightButton(Titanium.UI.iPhone.SystemButton.DISCLOSURE),F.setImage("FRE"!=U?"/images/redPin.png":"/images/greenPin.png")),m.push(F),g=b.toString(),p=w.toString(),I.next()}var k=Titanium.Map.createView({mapType:Titanium.Map.STANDARD_TYPE,animate:!0,regionFit:!0,userLocation:!0,zIndex:1,annotations:m});s.add(k),k.addEventListener("complete",function(){k.setRegion({latitude:g,longitude:p,latitudeDelta:.5,longitudeDelta:.5}),k.removeEventListener("complete",function(){})}),k.addEventListener("click",function(t){if("rightButton"==t.clicksource||"title"==t.clicksource||"subtitle"==t.clicksource){null==o?o=t.annotation.myid:null!=o&&null==r?r=t.annotation.myid:null!=o&&null!=r&&null==d&&(d=t.annotation.myid);{var i=require("/builders/createApplicationWindow");i(e,"children/featuredListing",t.annotation.title,"#FFF",n,o,r,d,t.annotation.myid,null)}}});var V=Ti.UI.createView({left:-360,bottom:40,width:250,height:233,backgroundColor:"#000",opacity:.8,zIndex:2}),N=Ti.UI.createImageView({image:"/images/mapkey.png",bottom:40,left:0,height:38,zIndex:2});s.add(N),s.add(V);var O=Ti.UI.createImageView({image:"/images/map_key.png",color:"#666",opacity:1,width:250,height:233,zIndex:1});V.add(O);var C=Titanium.UI.createView({width:"45%",height:"10%",top:"60%",left:"5%",zIndex:"3"});C.addEventListener("click",function(){k.setMapType(Titanium.Map.STANDARD_TYPE)}),V.add(C);var P=Titanium.UI.createView({width:"55%",height:"10%",top:"72%",left:"5%",zIndex:3});P.addEventListener("click",function(){k.setMapType(Titanium.Map.SATELLITE_TYPE)}),V.add(P);var R=Titanium.UI.createView({width:"50%",height:"10%",top:"85%",left:"5%",zIndex:3});R.addEventListener("click",function(){k.setMapType(Titanium.Map.HYBRID_TYPE)}),V.add(R),N.addEventListener("click",function(){1==N._left?(V.animate({left:-250,duration:775}),N.animate({left:0,duration:775}),N._left=!1):(N.animate({left:250,duration:775}),N._left=!0,V.animate({left:0,duration:775}))})}return h.close(),s}module.exports=createMapView;